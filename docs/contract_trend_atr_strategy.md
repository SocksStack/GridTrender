# 合约趋势 + ATR 策略总体方案评估

## 1. 在现有框架上扩展合约交易的可行性
- **客户端层面**：`exchange_client.ExchangeClient` 目前强制 `defaultType='spot'`，并显式关闭 `margin/swap/future`。若要接入合约，需要：
  - 切换或拆分交易所实例，支持 `swap`/`future` 市场、逐仓/全仓、杠杆参数。
  - 改写资金接口：合约账户的可用余额、保证金率、未实现盈亏需通过 `fetch_balance({'type': 'future'})` 或专有 REST 端点获取。
  - 处理 `position`/`leverage` API，补充 `set_leverage`、`set_margin_mode`、`fetch_positions` 等方法，并缓存合约专属精度 (合约张价值)。
- **风险管理层面**：`AdvancedRiskManager` 当前基于现货持仓比例，需要扩展：
  - 将风控目标从“仓位占总资产”转化为“名义价值 / 账户权益”，并引入维持保证金、强平价的监控。
  - 增加逐仓与多交易对共用保证金的隔离逻辑，避免网格与合约相互挤占仓位。
- **订单执行层面**：`GridTrader.execute_order` 假设限价单+现货撮合。合约侧需要：
  - 支持市价/条件单、撮合双向持仓、`reduce_only`、`post_only` 控制。
  - 处理双向开平与平仓逻辑（多空对称），并管理持仓快照。
- **结论**：架构具备可扩展性，但需在客户端、风控、仓位追踪三层进行模块化改造，建议以 SOLID 原则拆出 `AbstractTrader` / `DerivativeTrader`，通过依赖注入实现多市场支持。

## 2. 策略大纲：趋势跟随 + ATR 风险控制
- **行业经验**：趋势 + 波动率的组合是 CTA、Turtle Trading、Managed Futures 的经典框架，稳定性来自“趋势确认 + 波动率自适应仓位”。
- **核心要素**：
  - **趋势过滤**：使用双均线（EMA50/EMA200）、KAMA 斜率或 Donchian 通道突破确认大级别方向。
  - **触发条件**：在趋势方向内，当价格回踩中枢或突破区间时产生入场信号。
  - **ATR 应用**：ATR 用于 (1) 设置初始/跟踪止损；(2) 计算仓位规模；(3) 判断市场是否处于高噪声状态。

## 3. 推荐的交易周期与多周期协同
- **大周期**：4 小时或 1 小时作为趋势识别周期（行业常用），确保覆盖日内趋势但不过度延迟。
- **执行周期**：15 分钟或 5 分钟用于精细化入场、止损调整，减少滑点。
- **顶层过滤**：日线级别的 200EMA/布林带宽度可用于识别宏观震荡期，决定合约符号是否启用策略。
- **轮询节奏**：维持现有 `asyncio` 架构，趋势信号按大周期收盘更新，执行周期在小周期每根 K 线评估一次。

## 4. 交易信号生成参考实现
1. **趋势判定**（高频更新较慢）：
   - `EMA50 > EMA200` 且 EMA200 上行，则趋势多头有效；反之为空头。
   - 结合 `ADX(14) > 25` 或 `ATR/price` 达到阈值，过滤掉无趋势期。
2. **入场触发**：
   - 多头示例：价格上穿 `Donchian(20)` 上轨，或回踩 `EMA50` 并出现多头 K 线形态；空头对称。
   - 更稳健的做法是将 ATR 与价格的乖离比（`(close - EMA50)/ATR`）设为最小触发值，例如 > 1.0。
3. **止损与退出**：
   - 初始止损：`entry_price - N * ATR`（多头，常见 N=2~3），多空对称。
   - 移动止损：K 线收盘价跌破 `Chandelier Exit` 或 `(highest_close - M * ATR)`。
   - 时间止损：若 N 根执行周期后未获利 >= 0.5 * ATR，主动减仓。
4. **平仓/反手**：趋势破坏（均线交叉或 ADX < 阈值）时全量平仓；若出现对向信号则在平仓后按相同规则反手。

## 5. ATR 在仓位与风险中的应用
- **仓位 sizing**：`position_size = (account_equity * risk_per_trade) / (ATR * contract_multiplier)`；`risk_per_trade` 建议 0.5%~1%。保证金模式下需要将名义价值换算至合约张数。
- **波动率调节杠杆**：在 ATR 占比高（波动剧烈）时自动降低杠杆，例如设定 `effective_leverage = base_leverage * (target_vol / realized_vol)`。
- **多币种协同**：利用 ATR 占比对不同标的统一风险权重，避免高波动合约放大权益波动。

## 6. 规避震荡行情止损的策略
- **波动率过滤**：当 `ATR` 与 `true_range` 的 Rolling Ratio 小于阈值（说明价格在收敛），暂停交易。
- **区间识别**：利用布林带带宽、RSI 50±10 区间、HH/LL 未刷新等条件，判定横盘并降低仓位或只做区间策略。
- **多周期确认**：只有当上级周期（1H）与执行周期（15m）方向一致时才发单，减少噪声驱动的假突破。
- **时间窗限制**：避开资金费率结算前后或宏观数据发布的高噪音时段。
- **阶梯式入场**：采用分批建仓 + 贡献止损（partial stop）方式，让首批仓位验证趋势有效性。
- **统计型过滤**：可引入 `Range Filter` 或 `Keltner Channel` 检测价位是否在均值回归区间，若在区间内则转为卖方策略或观望。

## 7. 仓位与资金管理补充
- **权益维护**：每根合约需跟踪 `initial_margin`、`maintenance_margin`，`RiskManager` 应根据权益浮动动态调整最大持仓。
- **组合层面**：设置总权益 `VaR`／`CVaR` 上限，防止多标的同向爆仓；可引入相关性矩阵，做风险平价分配。
- **资金费率**：合约策略需将资金费率计入收益模型；当费率对持仓不利时，可提前减仓或对冲。

## 8. 需要补充的工程与研究工作
- **回测框架**：实现合约级别的回测/仿真模块，处理杠杆、资金费率、滑点、交易手续费。
- **状态持久化**：扩展 `trader_state_*` 保存多空持仓信息、止损价、资金费率计费时间。
- **信号服务化**：将趋势计算与 ATR 指标计算抽象成独立服务或任务，便于多交易对共享结果。
- **监控告警**：新增强平预警、保证金率告警、资金费率提醒。
- **合规与风控**：关注交易所合约 API 速率限制、强平流程、跨币种保证金的联动。

## 9. 推荐落地顺序
1. 抽象交易层：定义 `BaseTrader` 接口，拆分现货与合约实现，满足依赖倒置原则。
2. 扩展 `ExchangeClient`，支持合约市场、杠杆、仓位查询与下单模式。
3. 构建趋势 + ATR 指标模块，确保指标计算可复用并易测试。
4. 实现回测/仿真，验证参数（ATR 倍数、ADX 阈值、EMA 周期、风险敞口）。
5. 逐步联调实盘：先以较低杠杆、限价/限频交易验证逻辑，监控资金费率与滑点。

该方案沿用业界稳健的趋势跟随骨架，以 ATR 统一风险控制，能在大多数主流永续合约上获得良好的风格一致性。关键在于分层改造现有框架、补齐杠杆风控、严格执行回测验证，再进入低杠杆实盘验证阶段。 
