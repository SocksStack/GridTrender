# 合约趋势 + ATR 策略扩展方案

## 1. 目标与假设
- **目标**：在现有现货网格框架基础上扩展出支持永续/期货的趋势跟随 + ATR 策略，实现中期跟随、波动率适配、可控杠杆。
- **基础假设**：
  - 接入交易所：币安 U 本位永续为主，后续可扩展至多交易所。
  - 数据频率：大周期 4H/1H 识别趋势，小周期 15m/5m 执行。
  - 风险承受能力：单策略单品种最大资金暴露不超过权益的 15%，单笔风险 0.5%~1%。

## 2. 架构扩展重点
### 2.1 模块划分
- **抽象接口**：新增 `AbstractTrader`（提供生命周期钩子、异步主循环、风险接口），保证遵循依赖倒置原则。
- **合约实现**：新增 `DerivativeTrendTrader`，负责合约账户操作（多空对称、逐仓/全仓设置、资金费率处理）。
- **数据服务**：封装 `IndicatorService`，负责 EMA/ADX/ATR 等指标的滚动计算，缓存与多交易对复用。
- **订单执行**：抽象 `OrderExecutor`，支持市价、条件单、`reduce_only` 等标志，隔离撮合细节。

### 2.2 客户端适配
- 扩展 `ExchangeClient` 为合约模式，新增：
  - `create_client(mode='spot'|'swap')` 工厂。
  - `set_leverage(symbol, leverage)`、`set_margin_mode(symbol, mode)`。
  - `fetch_positions(symbol)`、`fetch_balance({'type': 'future'})`。
  - `create_order(symbol, type, side, amount, price, params)`，参数带 `positionSide`、`reduceOnly` 等。
- 时间同步、缓存、限速逻辑保持一致，通过策略模式替换市场类型配置，满足开放封闭原则。

### 2.3 风控与仓位
- 重构 `AdvancedRiskManager`：
  - 新增仓位评价：`position_margin / account_equity`、`maintenance_margin_ratio`。
  - 引入 `max_leverage_per_symbol`、`portfolio_exposure_limit`。
  - 结合 ATR 调整杠杆：波动率越高，杠杆越低，保证 LSP。

### 2.4 状态与监控
- 持久化项：`position_side`、`entry_price`、`stop_loss`、`take_profit`、`last_atr`、`next_funding_time`。
- Web 监控增加：保证金率、未实现盈亏、资金费率、趋势方向、信号状态。

## 3. 策略流水线
1. **数据准备**
   - 拉取日线/4H/1H K 线，构建 EMA、KAMA、Donchian、ADX、ATR 指标。
   - 维护缓存队列（Deque），每根收盘钟点更新一次。
2. **趋势过滤**
   - 多头条件：`EMA50 > EMA200` 且 `EMA200` 上行，同时 `ADX(14) > 25`。
   - 空头条件：`EMA50 < EMA200` 且 `EMA200` 下行，同样要求 ADX。
   - 若条件均不满足则标记震荡，禁止开仓。
3. **结构确认**
   - 判断当前价格相对 `Donchian(20)`、`Keltner Channel` 的位置。
   - 通过 `(close - EMA50) / ATR` 确定是否达到最小趋势强度（> 1.0）。
   - 引入 `VWAP` 作为流动性过滤：价格需站在趋势方向的一侧。
4. **信号生成**
   - 多头入场：趋势 = 多头，价格突破 Donchian 上轨或回踩 EMA50 后出现多头 K 线，且 `(close - EMA50)/ATR >= 1`。
   - 空头入场：对称条件。
   - 若上次信号已触发则等待仓位管理器调度，避免重复开仓。
5. **仓位 sizing**
   - `risk_per_trade = min(config_risk, available_equity * risk_cap)`。
   - `position_size = risk_per_trade / (ATR * contract_multiplier)`。
   - 结合最大杠杆约束：`nominal = position_size * price` 不能超过 `equity * leverage_cap`。
6. **订单执行**
   - 采用分批建仓（最多三次）：首单 40%，剩余 2 次基于价格回撤 0.5 ATR 触发。
   - 所有订单使用 `reduce_only` 控制平仓、`post_only` 控制挂单逻辑。
7. **风险控制**
   - 初始止损：`stop = entry_price -/+ N * ATR`（多/空，其中 `N=2.5` 默认）。
   - 移动止损：使用 Chandelier Exit (`highest_close - M * ATR`)，或 `(entry_price ± max(ATR*trailing_factor, trailing_floor))`。
   - 时间止损：N 根执行周期未达到最小利润，则减半仓位。
   - 强平防护：若保证金率接近警戒值（例如 1.2），自动减仓或全平。
8. **退出条件**
   - 趋势破坏：EMA50 与 EMA200 发生相反交叉，立即市价平仓。
   - 反向信号：对向趋势 + 动量满足时，先平仓再反手。
   - 资金费率：负费率持续超过阈值时逐步减仓。

## 4. 参数与默认值建议
- **趋势指标**：EMA50/EMA200，ADX(14)，Donchian 20。
- **ATR**：基于执行周期（15m）计算，回溯 21 根。
- **止损系数**：初始 `N=2.5`，移动 `M=3.0`，最大回撤预警 `3.5 ATR`。
- **风险配置**：
  - 单交易对风险上限 1% 权益。
  - 总组合名义敞口 <= 3 倍权益。
  - 杠杆动态范围 [1, 5]，并随 ATR 线性缩放。
- **震荡过滤**：
  - `ADX < 20` 或 `ATR/price < 0.3%` 判定为低波动区。
  - 布林带宽度 < 1% 时仅允许减仓。

## 5. 多周期与调度
- 大周期（4H/1H）负责趋势状态，每根周期结束时刷新。
- 执行周期（15m/5m）负责开仓、止损、跟踪调整。
- `asyncio` 层面采用两条协程：
  - `signal_service`：按大周期更新趋势指标。
  - `execution_service`：按执行周期迭代订单、风控。
- 状态总线共享 `trend_state`、`atr_values` 等，避免重复计算。

## 6. 震荡行情规避策略
- **动态仓位**：当振幅/ATR 比低于阈值时自动降低基础仓位至 30%。
- **过滤器叠加**：RSI 位于 45~55 且 ADX < 20 时强制不交易。
- **波动率 regime**：利用 `Volatility Stop`（分段 ATR）判定振荡区间，只有突破区间上沿/下沿时才恢复交易。
- **价量验证**：引入 `OBV` 或 `Volume Delta`，若突破无量配合则信号降权。
- **时间过滤**：避开资金费率结算前 5 分钟及宏观事件窗口。

## 7. 风险与资金管理
- **组合风险**：
  - 计算多品种之间的相关矩阵，应用风险平价或最大最小波动约束。
  - 引入 `Portfolio VaR`/`CVaR` 监控，超过阈值自动减仓。
- **资金利用**：
  - 追踪合约账户权益、可用余额、未实现盈亏，及时调整杠杆。
  - 结合现货仓位（若保留）实现 delta 对冲或持仓抵消。
- **异常管理**：
  - 资金费率为负且绝对值 > 0.05% 时触发告警。
  - 交易所状态异常（API 延迟、限速）时切换至防御模式：仅减仓不加仓。

## 8. 实施路线图
1. **代码结构调整**：实现抽象 Trader、OrderExecutor、IndicatorService，确保现货/合约隔离。
2. **ExchangeClient 扩展**：添加合约相关 API 封装与配置载入。
3. **指标模块**：使用 `pandas`/`ta-lib` 或自研向量化实现，可在 `shared/` 下建立指标库。
4. **风险引擎**：改造 `AdvancedRiskManager`，引入保证金/杠杆计算。
5. **策略逻辑**：实现 `DerivativeTrendTrader.main_loop`，包含信号、下单、风控、持仓管理。
6. **回测框架**：构建离线模拟（支持滑点、资金费率、杠杆），验证参数组合。
7. **监控与告警**：扩展 Web UI，加入合约指标；PushPlus 增加资金费率/强平预警。
8. **灰度上线**：低杠杆 + 小仓位实盘验证，观察 1~2 周，再逐步扩大。

## 9. 未来增强方向
- **多策略融合**：与网格/做市策略共存，通过状态机实现动态切换。
- **机器学习信号**：引入趋势概率模型（如 LSTM、XGBoost），为突破提供置信度打分。
- **跨市场套保**：基于现货仓位做 delta 对冲，或在多交易所执行套利。
- **自动参数调优**：使用遗传算法/贝叶斯优化调整 ATR 倍数、ADX 阈值。
- **风控中心**：集中化管理账户风险、资金调度，实现多策略统一风控。

## 10. 回测与验证体系设计
### 10.1 核心目标
- 验证趋势 + ATR 策略在不同合约、不同波动 regimes 下的收益/风险表现。
- 仿真杠杆、资金费率、滑点、交易延迟等因素，确保实盘一致性。
- 支持参数批量调优与跨品种复用，避免过拟合。

### 10.2 框架模块划分
- **数据源模块**
  - 历史 K 线管理：支持多周期（1d/4h/1h/15m/5m）与分钟级聚合。
  - Tick/盘口重建（可选）：用于精细化滑点建模。
  - 资金费率/交易成本：拉取合约历史资金费率、手续费设定。
- **指标引擎**
  - 指标缓存：EMA、ADX、ATR、Donchian、Keltner、Chandelier Exit 等滚动计算共享。
  - 向量化实现：使用 `numpy/pandas` 或 `numba` 加速，保持 DRY。
- **撮合仿真**
  - 市价撮合：按 `price + slippage * ATR` 模拟冲击。
  - 限价/条件单：队列匹配，考虑挂单被动成交概率。
  - 分批建仓：支持多笔子订单的成交顺序与滑点差异。
- **账户模型**
  - 权益/保证金：计算 `account_equity`、`wallet_balance`、`initial/maintenance margin`。
  - 资金费率：按交易所规则（如 8h 一次）计入权益。
  - 杠杆调整：根据 `effective_leverage` 控制最大仓位。
- **策略运行器**
  - `StrategyContext`：提供行情、指标、账户、下单接口。
  - `DerivativeTrendStrategy`：封装信号生成、仓位管理、止损调度逻辑，与实盘保持一致。
  - 事件驱动：大周期触发趋势刷新，小周期驱动执行。
- **风险引擎**
  - 监控浮动盈亏、回撤、保证金率、VaR。
  - 配置组合限制：名义敞口、横截面风险相关性。
- **评估与可视化**
  - 指标：年化收益、Sharpe、Sortino、Calmar、最大回撤、回撤持续时间、胜率、盈亏比、交易次数、资金费率贡献。
  - 图表：净值曲线、仓位曲线、回撤曲线、参数敏感度热力图。
  - 日志：记录每笔信号、订单、止损移动，方便复盘。
- **批量调优**
  - 参数网格/随机搜索：如 ATR 倍数、ADX 阈值、EMA 周期。
  - 贝叶斯优化/遗传算法：在回撤限制下最大化收益。
  - Walk-forward/滚动窗口：验证参数稳定性。

### 10.3 关键技术要点
- **异步仿真**：如需复用 `asyncio` 逻辑，可在回测环境中模拟事件循环，保持策略代码一致性。
- **性能优化**：对计算密集部分使用向量化、`numba` 或 Cython，避免 Python 循环。
- **精度控制**：资金费率、手续费需按交易所精度四舍五入，保持与实盘一致。
- **可扩展性**：为未来接入其他策略（如均值回归、套利）预留 Hook。

### 10.4 验证流程
1. 数据完整性校验（缺失、异常值、合约更换）。
2. 单参数回测 → 多参数网格 → Walk-forward → 实盘对比。
3. 审查关键情境（高波动、黑天鹅、极端费率）。
4. 在沙盒或小资金实盘验证，评估滑点偏差。

该扩展方案在充分利用现有框架的异步与模块化优势基础上，引入合约市场所需的交易、风险、监控能力，并提供可落地的策略执行流水线。依照 KISS/KISS、SOLID、DRY、YAGNI 原则，建议按模块逐步推进，确保每一步都有可验证的产出。 
